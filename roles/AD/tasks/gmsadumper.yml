
- name: gmsadumper - create project directory for "{{ login_user }}" user
  file:
    path: "{{ login_home }}/gmsadumper"
    state: directory
    owner: "{{ login_user }}"
    group: "{{ login_user }}"
    mode: "0755"
  tags:
    - gmsadumper
    - AD

- name: gMSADumper – clone upstream repository
  ansible.builtin.git:
    repo: https://github.com/micahvandeusen/gMSADumper.git
    dest: "{{ login_home }}/gmsadumper"
    version: "HEAD"
    update: yes
    force: yes
  become_user: "{{ login_user }}"
  tags:
    - gmsadumper
    - AD

- name: gmsadumper - create Python virtualenv (runs as "{{ login_user }}")
  command: python3 -m venv "{{ login_home }}"/gmsadumper/venv
  args:
    creates: "{{ login_home }}/gmsadumper/venv/bin/activate"
  become: yes
  become_user: "{{ login_user }}"
  tags:
    - gmsadumper
    - AD

- name: gMSADumper – install Python requirements into venv
  ansible.builtin.pip:
    requirements: "{{ login_home }}/gmsadumper/requirements.txt"
    virtualenv: "{{ login_home }}/gmsadumper/venv"
    virtualenv_command: /usr/bin/python3 -m venv
  become_user: "{{ login_user }}"
  tags:
    - gmsadumper
    - AD

- name: gMSADumper – create wrapper script in /usr/local/bin
  ansible.builtin.copy:
    dest: /usr/local/bin/gMSADumper
    mode: "0755"
    owner: root
    group: root
    content: |
      #!/usr/bin/env bash
      exec "{{ login_home }}"/gmsadumper/venv/bin/python "{{ login_home }}"/gmsadumper/gMSADumper.py "$@"
  tags:
    - gmsadumper
    - AD
