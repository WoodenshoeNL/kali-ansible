
- name: gmsadumper - create project directory for Kali user
  file:
    path: /home/kali/gmsadumper
    state: directory
    owner: kali
    group: kali
    mode: "0755"

- name: gMSADumper – clone upstream repository
  ansible.builtin.git:
    repo: https://github.com/micahvandeusen/gMSADumper.git
    dest: /home/kali/gmsadumper
    version: "HEAD"
    update: yes
    force: yes
  become_user: kali

- name: gmsadumper - create Python virtualenv (runs as kali)
  command: python3 -m venv /home/kali/gmsadumper/venv
  args:
    creates: /home/kali/gmsadumper/venv/bin/activate
  become: yes
  become_user: kali

#- name: gmsadumper - install gmsadumper inside the virtualenv (runs as kali)
#  pip:
#    name: gmsadumper
#    virtualenv: /home/kali/gmsadumper/venv
#    virtualenv_python: python3
#    state: latest              # change to “present” if you prefer pinning
#  become: yes
#  become_user: kali

- name: gMSADumper – install Python requirements into venv
  ansible.builtin.pip:
    requirements: /home/kali/gmsadumper/requirements.txt
    virtualenv: /home/kali/gmsadumper/venv
    virtualenv_command: /usr/bin/python3 -m venv
  become_user: kali

#- name: gmsadumper - create global wrapper in /usr/local/bin
#  file:
#    src: /home/kali/gmsadumper/venv/bin/gmsadumper
#    dest: /usr/local/bin/gmsadumper
#    state: link
#    force: yes 

- name: gMSADumper – create wrapper script in /usr/local/bin
  ansible.builtin.copy:
    dest: /usr/local/bin/gMSADumper
    mode: "0755"
    owner: root
    group: root
    content: |
      #!/usr/bin/env bash
      exec /home/kali/gmsadumper/venv/bin/python /home/kali/gmsadumper/gMSADumper.py "$@"
