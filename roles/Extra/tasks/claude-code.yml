- name: Claude Code - Check if Claude Code is installed
  ansible.builtin.shell: command -v claude
  register: claude_code_check
  changed_when: false
  failed_when: false
  become_user: "{{ login_user }}"
  when: vmware_env == "claude_code"
  tags:
    - claude_code

- name: Claude Code - Create directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ login_user }}"
    group: "{{ login_user }}"
    mode: '0755'
  loop:
    - "{{ login_home }}/.local/bin"
    - "{{ login_home }}/.local/share/claude"
    - "{{ login_home }}/.claude"
  when: 
    - claude_code_check.rc != 0
    - vmware_env == "claude_code"
  tags:
    - claude_code

- name: Claude Code - Get latest stable version
  ansible.builtin.uri:
    url: "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/stable"
    return_content: yes
  register: claude_version
  when: 
    - claude_code_check.rc != 0
    - vmware_env == "claude_code"
  tags:
    - claude_code

- name: Claude Code - Download binary
  ansible.builtin.get_url:
    url: "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/{{ claude_version.content }}/linux-x64/claude"
    dest: "{{ login_home }}/.local/share/claude/claude"
    mode: '0755'
    owner: "{{ login_user }}"
    group: "{{ login_user }}"
  when: 
    - claude_code_check.rc != 0
    - vmware_env == "claude_code"
  tags:
    - claude_code

- name: Claude Code - Create symlink
  ansible.builtin.file:
    src: "{{ login_home }}/.local/share/claude/claude"
    dest: "{{ login_home }}/.local/bin/claude"
    state: link
    owner: "{{ login_user }}"
    group: "{{ login_user }}"
  when: 
    - claude_code_check.rc != 0
    - vmware_env == "claude_code"
  tags:
    - claude_code

- name: Claude Code - Ensure PATH includes ~/.local/bin in .bashrc
  ansible.builtin.lineinfile:
    path: "{{ login_home }}/.bashrc"
    line: 'export PATH="$HOME/.local/bin:$PATH"'
    regexp: '.*\.local/bin.*PATH'
    state: present
  become_user: "{{ login_user }}"
  when: vmware_env == "claude_code"
  tags:
    - claude_code