
- name: Mullvad - Install required dependencies
  ansible.builtin.apt:
    name:
      - curl
      - gnupg
    state: present
    update_cache: yes
  when: vmware_env == "vpn"
  tags:
    - mullvad
    - vpn

- name: Mullvad - Download Mullvad GPG key
  ansible.builtin.get_url:
    url: https://repository.mullvad.net/deb/mullvad-keyring.asc
    dest: /tmp/mullvad-keyring.asc
    mode: '0644'
  when: vmware_env == "vpn"
  tags:
    - mullvad
    - vpn

- name: Mullvad - Dearmor and install Mullvad GPG key
  ansible.builtin.shell: |
    gpg --dearmor < /tmp/mullvad-keyring.asc > /usr/share/keyrings/mullvad-keyring.gpg
  args:
    executable: /bin/bash
    creates: /usr/share/keyrings/mullvad-keyring.gpg
  when: vmware_env == "vpn"
  tags:
    - mullvad
    - vpn

- name: Mullvad - Add Mullvad repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/mullvad-keyring.gpg] https://repository.mullvad.net/deb/stable {{ ansible_distribution_release }} main"
    filename: mullvad
    state: present
  when: vmware_env == "vpn"
  tags:
    - mullvad
    - vpn

- name: Mullvad - Install Mullvad VPN package
  ansible.builtin.apt:
    name: mullvad-vpn
    state: present
    update_cache: yes
  when: vmware_env == "vpn"
  tags:
    - mullvad
    - vpn

- name: Mullvad - Clean up temporary files
  ansible.builtin.file:
    path: /tmp/mullvad-keyring.asc
    state: absent
  when: vmware_env == "vpn"
  tags:
    - mullvad
    - vpn
