

- name: Common - Cleanup legacy Microsoft/Azure CLI repo configurations
  ansible.builtin.file:
    path: "/etc/apt/sources.list.d/{{ item }}"
    state: absent
  loop:
    - microsoft-prod.list
    - azcli.list
    - azure-cli.list
  tags:
    - common
    - core

- name: Common - Cleanup conflicting Microsoft keyring
  ansible.builtin.file:
    path: /usr/share/keyrings/microsoft.asc.gpg
    state: absent
  tags:
    - common
    - core

# Ensure Microsoft GPG key exists so any existing packages.microsoft.com repo (e.g. VS Code/Cursor) can verify.
# Without this, "Add Microsoft PowerShell repository" can fail with "Failed to update apt cache" when the code repo has NO_PUBKEY.
- name: Common - Ensure keyrings directory exists
  ansible.builtin.file:
    path: /usr/share/keyrings
    state: directory
    mode: '0755'
  when: ansible_os_family == 'Debian'
  tags:
    - common
    - core

- name: Common - Download Microsoft GPG key
  ansible.builtin.get_url:
    url: https://packages.microsoft.com/keys/microsoft.asc
    dest: /tmp/microsoft-common.asc
    mode: '0644'
    force: yes
  when: ansible_os_family == 'Debian'
  tags:
    - common
    - core

- name: Common - Install Microsoft GPG key for existing repos (e.g. code)
  ansible.builtin.shell: |
    gpg --batch --yes --dearmor -o /usr/share/keyrings/microsoft.gpg /tmp/microsoft-common.asc
  when: ansible_os_family == 'Debian'
  tags:
    - common
    - core

- name: Common - Find sources that reference Microsoft code repo
  ansible.builtin.find:
    paths: /etc/apt/sources.list.d
    patterns: '*.list,*.sources'
    contains: 'packages.microsoft.com/repos/code'
  register: code_repo_sources_files
  when: ansible_os_family == 'Debian'
  tags:
    - common
    - core

- name: Common - Fix existing Microsoft code repo to use keyring (fix NO_PUBKEY)
  ansible.builtin.replace:
    path: "{{ item }}"
    regexp: '^deb (\[arch=amd64\] )?https://packages\.microsoft\.com/repos/code stable main$'
    replace: 'deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/code stable main'
  loop: "{{ (code_repo_sources_files.files | default([])) | map(attribute='path') | list }}"
  when:
    - ansible_os_family == 'Debian'
    - code_repo_sources_files is not skipped
    - (code_repo_sources_files.matched | default(0)) > 0
  tags:
    - common
    - core

- name: Update indexes and perform full upgrade
  ansible.builtin.apt:
    update_cache: yes
    upgrade: dist
    cache_valid_time: 3600
  tags:
    - core
    - common

- name: Run vmware mount
  import_tasks: vmware.yml

- name: Install core packages
  apt:
    name:
      - zsh
      - docker.io
      - docker-compose
      - python3
      - python3-pip
      - python3-virtualenv
      - python3-lxml
      - git
      - pipx
      - golang
      - jq
      - moreutils
      - rlwrap
      - git
      - build-essential
      - freerdp3-x11
      - unzip
      - libssl-dev
      - pkg-config
      - gcc
      - libpcre2-dev
      - vim
    state: present
    update_cache: yes
    cache_valid_time: 3600
  tags:
    - core
    - common

- name: Run tmux setup
  import_tasks: tmux.yml

- name: Run firefox quiet script
  import_tasks: firefox.yml

- name: Run disable screenlock script
  import_tasks: disable_screen_lock.yml

- name: Create stockpile
  import_tasks: stockpile.yml

- name: Run Powershell setup
  import_tasks: powershell.yml

- name: Run impacket setup
  import_tasks: im_packet.yml

- name: Run uv setup (Python runner)
  import_tasks: uv.yml

- name: Run vscode setup
  import_tasks: vscode.yml

- name: Run chrome setup
  import_tasks: chrome.yml

- name: Run obsidian setup
  import_tasks: obsidian.yml

- name: Run rust setup
  import_tasks: rust.yml

#- name: Run Fix mouse pointer
#  import_tasks: fix-mouse-pointer.yml

- name: Run DuckDB setup
  import_tasks: duckdb.yml

- name: Run foxyproxy setup
  import_tasks: foxyproxy.yml

- name: Run seclists setup
  import_tasks: seclists.yml

