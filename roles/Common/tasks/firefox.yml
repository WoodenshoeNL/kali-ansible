
- name: Ensure Firefox is installed
  package:
    name: firefox-esr
    state: present
  when: vmware_env in ["workstation", "laptop"]
  tags:
    - Firefox
    - common

- name: Firefox - Make sure {{ login_home }}/scripts exists
  file:
    path: "{{ login_home }}/scripts"
    state: directory
    mode: "0755"
  when: vmware_env in ["workstation", "laptop"]
  tags:
    - Firefox
    - common

- name: Firefox - Copy quiet_firefox.py into {{ login_home }}/scripts
  copy:
    src: quiet_firefox.py
    dest: "{{ login_home }}/scripts/quiet_firefox.py"
    mode: "0755"
  when: vmware_env in ["workstation", "laptop"]
  tags:
    - Firefox
    - common

- name: Firefox - Check if a Firefox profile already exists
  stat:
    path: "{{ login_home }}/.mozilla/firefox/profiles.ini"
  register: fx_profile
  become: true
  become_user: "{{ login_user }}"
  when: vmware_env in ["workstation", "laptop"]
  tags:
    - Firefox
    - common

- name: Firefox - Create a default Firefox profile (headless) when needed
  command: firefox --headless --createprofile default
  args:
    creates: "{{ login_home }}/.mozilla/firefox/profiles.ini"
  become: true
  become_user: "{{ login_user }}"
  environment:
    HOME: "{{ login_home }}"
  when: vmware_env in ["workstation", "laptop"]
  tags:
    - Firefox
    - common

- name: Firefox - Run quiet_firefox.py inside the {{ login_user }} profile
  command: python3 quiet_firefox.py
  args:
    chdir: "{{ login_home }}/scripts"
  become: true
  become_user: "{{ login_user }}"
  environment:
    HOME: "{{ login_home }}"
  when: vmware_env in ["workstation", "laptop"]
  tags:
    - Firefox
    - common
