
- name: Install required dependencies
  ansible.builtin.apt:
    name:
      - curl
      - gnupg
    state: present
    update_cache: yes
  tags:
    - mullvad
    - vpn
    - common

- name: Download Mullvad GPG key
  ansible.builtin.get_url:
    url: https://repository.mullvad.net/deb/mullvad-keyring.asc
    dest: /tmp/mullvad-keyring.asc
    mode: '0644'
  tags:
    - mullvad
    - vpn
    - common

- name: Dearmor and install Mullvad GPG key
  ansible.builtin.shell: |
    gpg --dearmor < /tmp/mullvad-keyring.asc > /usr/share/keyrings/mullvad-keyring.gpg
  args:
    executable: /bin/bash
    creates: /usr/share/keyrings/mullvad-keyring.gpg
  tags:
    - mullvad
    - vpn
    - common

- name: Add Mullvad repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/mullvad-keyring.gpg] https://repository.mullvad.net/deb/stable {{ ansible_distribution_release }} main"
    filename: mullvad
    state: present
  tags:
    - mullvad
    - vpn
    - common

- name: Install Mullvad VPN package
  ansible.builtin.apt:
    name: mullvad-vpn
    state: present
    update_cache: yes
  tags:
    - mullvad
    - vpn
    - common

- name: Clean up temporary files
  ansible.builtin.file:
    path: /tmp/mullvad-keyring.asc
    state: absent
  tags:
    - mullvad
    - vpn
    - common